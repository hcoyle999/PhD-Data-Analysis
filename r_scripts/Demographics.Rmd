---
title: "Demographics"
author: "Hannah Coyle"
email: "hannah.coyle@monash.edu"
date: "`r Sys.Date()`"
output: html_document
---
# Analysising clinical and cognitive data across three time points in a sample of mild traumatic brain injury (mtbi) patient.s

# Hannah Coyle, , January 2019
  #This r markdown document and output is for my demographic information. Includes summaries, tables etc

```{r global_option, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=TRUE, warning=FALSE, message=FALSE, eval=TRUE)
```

```{r get my saved data frame, include=FALSE}
## Open my R data file and select dataframes and save (this is step 1 if working off a clear workspace)
load("~/Documents/PHD-Data-Analysis/PHD-Data-Analysis/Analysis/Data/COMBINED_COG_PhD.Rdata")

# control_df <- filter(COMBINED_COG_PhD,group == "control") #control_df
# mtbi_df <- filter(COMBINED_COG_PhD,group == "mtbi") #mtbi_df
# clin_data_BL <- select(COMBINED_COG_PhD,code, group, hads_anxiety_bl:mfi_mf_bl) # clinical_df at baseline
# cog_data_BL <- select(COMBINED_COG_PhD,code, group, wtar:bvmt_recognition) # cog_df at baseline

#exclude participants
COMBINED_COG_PhD <-subset(COMBINED_COG_PhD,!code %in% c(7, 16))
```
# 1.Run normality tests on demographic information (to do)
```{r Normality tests, include=FALSE}

```
# 2.Create demographics table for both groups
```{r Demographics table, include=FALSE}

library(tableone)
#change categorical variables to factors
myVars <- c("sex", "age", "education", "wtar")
catVars <- c("sex")

#create table by group
tab1 <- CreateTableOne(vars = myVars, strata = "group" , data = COMBINED_COG_PhD, factorVars = catVars)
print(tab1)

#if you want to specify nonnormal data you can do that as well (quote arguments avoids the mishandling of spaces)
  #create a variables that are nonnormal (BUT haven't checked that these aren't yet)
print(tab1, nonnormal= c("age", "education"), exact= c("wtar"), cramVars = "sex", quote= TRUE)

#view categorical and continuous parts of the table
tab1$CatTable
tab1$ContTable

#export into .csv/ excel and save table 
library(xlsx)
tab1Mat<- print(tab1, exact="stage", quote=TRUE, nospaces=TRUE,printToggle = FALSE)
write.csv(tab1Mat, file="/Users/han.coyle/Documents/PHD-Data-Analysis/PHD-Data-Analysis/Analysis/Tables/demographics.csv")
#the above step is because stargazer can't deal with the data in "table 1" format
dem_table<-read_csv(file="~/Documents/PHD-Data-Analysis/PHD-Data-Analysis/Analysis/Tables/demographics.csv")
dem_table<-as.data.frame(dem_table) #stargazer does not work well wth tbl_df so change to data frame

#create stargazer output and save as html
stargazer(dem_table, title= "Demographic information", summary = FALSE, out="~/Documents/PHD-Data-Analysis/PHD-Data-Analysis/Analysis/Tables/demographics.html")




```
#3.Create summary table for clinical data (control and mtbi sample)
```{r Clinical data table, include=FALSE}
#change categorical variables to factors
myVars_1 <- c(names(clin_data_BL))
myVars_1 <- myVars_1[-(1:2)] #remove code and group
catVars_1 <- c("group")

#create table by group
clin_tab_1 <- CreateTableOne(vars = myVars_1, strata = "group" , data = COMBINED_COG_PhD, factorVars = catVars_1)
print(clin_tab_1)

#see a summary of data (look for skew, kurtosis etc)
summary(clin_tab_1)

#create variable with non normal data (can input variable names and sub this in, but currently working on the premise that will run non parametric stats for all)
  #clin_non_normal <- c("hads_total_bl")

#if you want to specify nonnormal data you can do that as well (quote arguments avoids the mishandling of spaces)
  #currently including all variables as nonnormal (BUT haven't checked that these aren't yet)
print(clin_tab_1, nonnormal= myVars_1, quote= TRUE)

#export into .csv/ excel and save table 
clin_data_mat<- print(clin_tab_1, exact="stage", quote=TRUE, nospaces=TRUE,printToggle = FALSE)
write.csv(clin_data_mat, file="/Users/han.coyle/Documents/PHD-Data-Analysis/PHD-Data-Analysis/Analysis/Tables/clin_demographics.csv")

#example of a quick way of summmarising data
COMBINED_COG_PhD %>%
  group_by(group) %>%
  summarise(mean= mean(age, na.rm=TRUE), sd= sd(age), n=n()) 
  


```
#4.Lood at injury characteristics in data ( mtbi sample)
```{r injury characteristics, include=FALSE}
#mean time since injury for each session 
#baseline
dys_pst_injury_bl<-COMBINED_COG_PhD %>%
 filter(group=="mtbi") %>%
  select(dateofinjury, baseline, t1, t2) %>%
  mutate(diff = c(difftime(baseline, dateofinjury))) %>%
  mutate(diff= as.numeric(diff))

#calc sum stats
dys_pst_injury%>%
  summarise(mean= mean(diff, na.rm=TRUE), sd= sd(diff,na.rm=TRUE), n=n())

#  calc range ( can't calculate in pipe for some reason)
range(dys_pst_injury$diff,na.rm=TRUE)

#timepoint 1
dys_pst_injury_t1<-COMBINED_COG_PhD %>%
 filter(group=="mtbi") %>%
  select(dateofinjury, baseline, t1, t2) %>%
  mutate(diff = c(difftime(t1, dateofinjury))) %>%
  mutate(diff= as.numeric(diff))

#calc sum stats
dys_pst_injury_t1%>%
  summarise(mean= mean(diff, na.rm=TRUE), sd= sd(diff,na.rm=TRUE), n=n())

#  calc range ( can't calculate in pipe for some reason)
range(dys_pst_injury_t1$diff,na.rm=TRUE)

#timepoint 2 
dys_pst_injury_t2<-COMBINED_COG_PhD %>%
 filter(group=="mtbi") %>%
  select(dateofinjury, baseline, t1, t2) %>%
  mutate(diff = c(difftime(t2, dateofinjury))) %>%
  mutate(diff= as.numeric(diff))

#calc sum stats
dys_pst_injury_t2%>%
  summarise(mean= mean(diff, na.rm=TRUE), sd= sd(diff,na.rm=TRUE), n=n())

#  calc range ( can't calculate in pipe for some reason) - to fix 111 T2 date in SPSS
range(dys_pst_injury_t2$diff,na.rm=TRUE)

#not sure what this is- linear model of age and education??
fit <- lm(age ~ education, data= COMBINED_COG_PhD)
summary(fit)
par(mfrow = c(2, 2))
plot(fit) 
 #-----------------------------------
# calculate number individuals who had loc
COMBINED_COG_PhD %>%
  filter(group=="mtbi") %>%
  select(code, headinjury_hx, gcs, loc, loc_dur, amnesia, prior_injury,other_injury,ageofinjury) %>%
  mutate(loc= as.factor(loc)) %>%
  count(loc=="yes") # currently 13/30 loc yes, 12/30 loc no, 5/30 NA (check if this is unsure)

#percentages
  (12/30*100)
  (13/30*100)
  (5/30*100)
# mean and sd loc
describe(loc_dur)

#type of injury - ordered by factor of frequence
 COMBINED_COG_PhD %>%
  filter(group=="mtbi") %>%
  select(code, injury_class) %>%
  mutate(injury_class= as.factor(injury_class)) %>%
  ggplot(aes(fct_infreq(injury_class))) +
  geom_histogram(stat="count") + # can change fill colours
   theme_classic() +
   labs(x= "Injury Mechanism", y= "Frequency", title = "mTBI injury characteristics")+
 theme(plot.title = element_text(hjust = 0.5),plot.subtitle = element_text(hjust = 0.5))

 

#barplot of amnesia counts
counts <- table(mTBI_injury$amnesia)
barplot(counts, main="Amensia",  xlab="Type of Amnesia")
barplot(counts, main="Amensia", 
xlab="Type of Amnesia")

#create table
myVars_2 <- c(names(mTBI_injury))
myVars_2 <- myVars_2[-(1:1)] #remove code
catVars_2 <- c("loc","amnesia")

mtbi_injury_tab_1 <- CreateTableOne(vars = myVars_2, data = COMBINED_COG_PhD, factorVars = catVars_2)
print(mtbi_injury_tab_1)

#not sure if this is right and also need to update some of the data in the SPSS database- to come back to. 
```

```{r}

```

#Understand more about mTBI sample
```{r mtbi sample characteristics, include=TRUE}
#create mtbi table with PCS variable
mtbi_pcs<- mtbi_df %>%
  select(code, initals, amnesia, rpq_3_bl, rpq_13_bl, rpq_10_mtbi_t1,rpq_mtbi_t2 ) %>%
  mutate(pcs_bl = rpq_3_bl>=1, pcs_t1 = rpq_10_mtbi_t1>=1, pcs_t2 =rpq_mtbi_t2 >=1)
  
#change logicals to characters
mtbi_pcs$pcs_bl <- ifelse(mtbi_pcs$pcs_bl == TRUE, "yes", "no")
mtbi_pcs$pcs_t1 <- ifelse(mtbi_pcs$pcs_t1 == TRUE, "yes", "no")
mtbi_pcs$pcs_t2 <- ifelse(mtbi_pcs$pcs_t2 == TRUE, "yes", "no") 

#look at amnesia
mtbi_df %>%
  select(code, amnesia, rpq_3_bl, rpq_13_bl) %>%
  plot(rpq_3_bl,rpq_13_bl)

#visualisation of relationship between gcs, PCS symptom severity and LOC
p<- ggplot(mtbi_df, aes(x=gcs, y=rpq_13_bl, color=loc))
p + geom_jitter(alpha=0.3) + scale_color_manual(breaks = c('yes','no'),values=c('darkgreen','red'))

#visualisation of relationship between amnesia and PCS symptom severity 
q<- ggplot(mtbi_df, aes(x=gcs, y=rpq_13_bl, color=amnesia))

q + geom_jitter(alpha=0.3) + scale_color_manual(breaks = c('antegrade','retrograde','anterograde and retrograde','nil'),values=c('darkgreen','red','blue','orange'))

# linear model (i.e. how to do a correlation between a nominal (unordered categorical variable) iv and continuous dv)
mtbi_df %>%
select(code, rpq_13_bl,amnesia) %>%
count(amnesia)


model.lm <- lm(rpq_13_bl ~ amnesia, mtbi_df)
summary(model.lm)

#interpret the estimated intercept as giving the mean symptom severity of PCS symptoms as 13.85 for ?? *unclear which variable*, and the estimated coefficients for the dummy variables as showing retrograde amnesia symptoms were on average 0.75 points less severe then ?

#one-way ANOVA
model.aov <- aov(rpq_13_bl ~ amnesia, data = mtbi_df)
summary(model.aov)
#gives a summary with identical F stat and p=value

#chi-squared test (for two sets of categorical data)
chisq.test(mtbi_df$loc,mtbi_pcs$pcs_bl, correct = FALSE) # is there a relationship between loc (yes vs no) and presence of pcs (yes vs no)

chisq.test(mtbi_df$loc,mtbi_df$amnesia, correct = FALSE) #almost significant

#if significant this is a measure of association, NOT causality, can go on to test strength of association
#https://www.r-bloggers.com/to-eat-or-not-to-eat-thats-the-question-measuring-the-association-between-categorical-variables/

library(GoodmanKruskal)
varset1<- c("loc","amnesia")
loc_amn_Frame1<- subset(mtbi_df, select = varset1)
GKmatrix1<- GKtauDataframe(loc_amn_Frame1)
plot(GKmatrix1, corrColors = "blue")
```



